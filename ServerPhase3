from socket import *
from struct import *
import math
import time
import numpy as np
import cv2 as cv
import tkinter as tk
from PIL import Image, ImageTk
import datetime

serverPort = 12345

serverSocket = socket(AF_INET, SOCK_DGRAM)
serverSocket.bind(('', serverPort))
print("Server Opened At: %s" %datetime.datetime.now())



numPackets, clientAddress = serverSocket.recvfrom(2048)

receivedFile = []
receiving = 0
size = int(numPackets.decode())

counter = 0
while True:
   
    ######## RECIEVE AND UNPACK DATA #########
    counter = counter + 1
    message, clientAddress = serverSocket.recvfrom(2048)
    ACK, SEQ, data, checksum = unpack(f'ii 32s {len(message[8:])}s', message)
    ######## RECIEVE AND UNPACK DATA #########
    print(checksum)
    print(ACK)
    print(SEQ)
    print(data)
    print(f'{counter} = {data}')


    receivedFile.append(message)
    receiving = receiving + 1

    if receiving == size:
        break

image = receivedFile[0]
for i in range(1, size):
    image = image + receivedFile[i]


image = np.asarray(bytearray(image), dtype = "uint8")
image = cv.imdecode(image, cv.IMREAD_COLOR)

cv.imshow('img', image)
cv.waitKey()
